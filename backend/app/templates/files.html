{% extends 'base.html' %}

{% block head_extra %}
<style>
  /* ====== Modal 與表單樣式（沿用） ====== */
  .modal.hidden{display:none}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:1000}
  .modal .modal-body{background:#fff;width:640px;max-width:92vw;border-radius:8px;padding:16px;box-shadow:0 12px 40px rgba(0,0,0,.25)}
  .modal .modal-actions{display:flex;gap:8px;margin-top:12px}
  .muted{color:#6b7280;margin-top:8px}
  .btn-row{display:flex;gap:10px}
  .file-list{margin:8px 0;padding:6px 10px;border:1px solid #e5e7eb;border-radius:4px;background:#f9fafb;max-height:180px;overflow-y:auto;font-size:14px}
  .file-list:empty{display:none;padding:0;border:0;background:transparent}
  .file-list li{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px solid #eee}
  .file-list li:last-child{border-bottom:none}
  .file-list .meta{color:#6b7280;font-size:12px}
  .btn-link{background:transparent;border:0;padding:0;color:#2563eb;cursor:pointer}

  /* ====== 檔案表格與按鈕樣式 ====== */
  .files-actions{display:flex;align-items:center;gap:12px;margin:8px 0 6px;flex-wrap:wrap}
  .files-table{width:100%;border-collapse:collapse;table-layout:fixed;margin-top:16px}
  .files-table th,.files-table td{border-bottom:1px solid #e5e7eb;padding:10px 8px;vertical-align:middle;text-align:left}
  .files-table th{background:#f9fafb;font-weight:600;position:sticky;top:0;z-index:1}

  .col-select{width:44px}
  .col-hash{width:96px}
  .col-size{width:110px}
  .col-parsed{width:90px}
  .col-ops{width:220px}

  .cell-hash code{white-space:nowrap}
  .cell-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .cell-size{white-space:nowrap;text-align:right}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;line-height:18px}
  .badge-ok{background:#DCFCE7;color:#065F46}
  .badge-muted{background:#F3F4F6;color:#374151}

  .row-tools{display:flex;gap:8px;flex-wrap:nowrap;align-items:center;justify-content:flex-start}
  .row-tools > *{white-space:nowrap}

  .btn{display:inline-block;padding:6px 10px;border-radius:8px;font-size:14px;line-height:20px;text-decoration:none;cursor:pointer}
  .btn:focus{outline:2px solid rgba(59,130,246,.5);outline-offset:2px}
  .btn-primary{background:#111827;color:#fff;border:1px solid #111827}
  .btn-primary:hover{filter:brightness(.95)}
  .btn-outline{background:#fff;color:#2563eb;border:1px solid #e5e7eb}
  .btn-outline:visited,.btn-outline:hover{color:#2563eb}
  .btn-outline:hover{background:#f3f4f6}
  .btn-sm{padding:4px 8px;font-size:13px;border-radius:7px}

  /* 分頁列 */
  .pager{display:flex;align-items:center;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
  .select{border:1px solid #e5e7eb;border-radius:8px;padding:6px 10px;font-size:14px;background:#fff}
</style>
{% endblock %}

{% block content %}
<section>
  <h2>上傳/登錄</h2>
  <div class="btn-row">
    <button id="openUploadModal">上傳 PDF（可多檔）</button>
    <button id="openUrlModal">貼上下載連結（批量）</button>
  </div>

  <!-- 上傳 PDF Modal -->
  <div id="uploadModal" class="modal hidden">
    <div class="modal-body">
      <h3>上傳 PDF（可多檔）</h3>
      <form id="uploadMultiForm" enctype="multipart/form-data" method="post" action="/api/files/upload-multi">
        <input type="file" id="uploadFiles" name="files" accept="application/pdf" multiple />
        <ul id="fileList" class="file-list"></ul>
        <p class="muted">
          可一次選取多個 PDF。
          <button type="button" id="clearAllBtn" class="btn-link">清空清單</button>
        </p>
        <div class="modal-actions">
          <button type="submit">送出上傳</button>
          <button type="button" class="close">關閉</button>
        </div>
      </form>
      <div id="uploadMultiMsg" class="muted"></div>
    </div>
  </div>

  <!-- 貼上下載連結 Modal -->
  <div id="urlModal" class="modal hidden">
    <div class="modal-body">
      <h3>貼上下載連結（每行一個）</h3>
      <form id="urlBatchForm" method="post" action="/api/files/upload-urls" autocomplete="off">
        <textarea name="urls" placeholder="https://example.com/a.pdf&#10;https://example.com/b.pdf" style="width:520px;height:160px;"></textarea>
        <div style="margin:8px 0;">
          <input type="text" name="hsd_name" list="hsdOptions" placeholder="站點(例如 Mouser/DigiKey/...)" style="width:320px;" />
          <datalist id="hsdOptions">
            <option value="Mouser"></option>
            <option value="DigiKey"></option>
            <option value="Arrow"></option>
            <option value="Future"></option>
            <option value="RS"></option>
          </datalist>
        </div>
        <p class="muted">部分 HSD 站點需要模擬 session/headers 否則爬蟲下載檔案會失敗。</p>
        <div class="modal-actions">
          <button type="submit">建立下載任務</button>
          <button type="button" class="close">關閉</button>
        </div>
      </form>
      <div id="urlBatchMsg" class="muted"></div>
    </div>
  </div>
</section>

<section>
  <h2>檔案清單</h2>

  <div class="files-actions">
    <button id="btnExtractSelected" class="btn btn-primary btn-sm">加入解析佇列（已選）</button>
    <label class="muted" title="若已解析過，仍強制重新入列解析">
      <input type="checkbox" id="chkForceRerun" />
      強制重新解析
    </label>
  </div>

  <table class="files-table my-10">
    <colgroup>
      <col class="col-select">
      <col class="col-hash">
      <col> <!-- 檔名吃剩餘寬度 -->
      <col class="col-size">
      <col class="col-parsed">
      <col class="col-ops">
    </colgroup>
    <thead>
      <tr>
        <th><input type="checkbox" id="chkAll" /></th>
        <th>hash</th>
        <th>檔名</th>
        <th>大小</th>
        <th>已解析？</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="filesTbody"><!-- 由 JS 動態渲染 --></tbody>
  </table>

  <div class="pager">
    <button type="button" id="prev" class="btn btn-outline">上一頁</button>
    <span>第 <span id="page">1</span> / <span id="pages">1</span> 頁（共 <span id="total">0</span> 筆）</span>
    <button type="button" id="next" class="btn btn-outline">下一頁</button>
    <select id="pageSize" class="select" title="每頁筆數">
      <option>20</option><option selected>50</option><option>100</option><option>200</option>
    </select>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
/* ========= 狀態 ========= */
let page = 1, pages = 1, total = 0, pageSize = 50;
let items = [];
const selected = new Set(); // 跨頁維持勾選

/* ========= 小工具 ========= */
const $ = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
const escapeHtml = (s) => (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const humanSize = (n) => {
  const v = Number(n||0); if (!isFinite(v) || v<0) return '-';
  const units = ['B','KB','MB','GB','TB','PB']; let val=v, i=0;
  while (val>=1000 && i<units.length-1){ val/=1000; i++; }
  const num = (Math.round(val*10)/10).toString();
  return `${num}${num.includes('.')?'':' '} ${units[i]}`;
};

/* ========= API ========= */
/* 後端回傳結構假定為：
   { items:[{file_hash, filename, size_bytes, parsed}], total, page, page_size } */
async function fetchPage(p=1, ps=50){
  const u = new URLSearchParams({ page:String(p), page_size:String(ps) });
  const res = await fetch(`/api/files?${u.toString()}`);
  if (!res.ok) throw new Error(await res.text().catch(()=>`HTTP ${res.status}`));
  return res.json();
}

/* ========= Render ========= */
function renderTable() {
  const tb = $("#filesTbody");
  tb.innerHTML = '';
  for (const f of items){
    const tr = document.createElement('tr');
    tr.dataset.fileHash = f.file_hash;
    tr.innerHTML = `
      <td><input type="checkbox" class="chkRow" value="${escapeHtml(f.file_hash)}" ${selected.has(f.file_hash)?'checked':''}></td>
      <td class="cell-hash"><code>${escapeHtml((f.file_hash||'').slice(0,8))}</code></td>
      <td class="cell-name" title="${escapeHtml(f.filename)}">${escapeHtml(f.filename)}</td>
      <td class="cell-size">${humanSize(f.size_bytes)}</td>
      <td>${f.parsed ? '<span class="badge badge-ok">是</span>' : '<span class="badge badge-muted">否</span>'}</td>
      <td>
        <div class="row-tools">
          <a class="btn btn-outline btn-sm" href="/pdf/${encodeURIComponent(f.file_hash)}" target="_blank" rel="noopener">開啟 PDF</a>
          <a class="btn btn-outline btn-sm" href="/files/${encodeURIComponent(f.file_hash)}">查看詳情</a>
        </div>
      </td>
    `;
    tb.appendChild(tr);
  }

  // 綁勾選
  tb.querySelectorAll('.chkRow').forEach(ch => {
    ch.addEventListener('change', (e) => {
      const h = e.target.value;
      if (e.target.checked) selected.add(h); else selected.delete(h);
      syncChkAll();
      updateActionButtons();
    });
  });

  syncChkAll();
  updateActionButtons();
}

function updatePager(){
  $("#page").textContent = String(page);
  $("#pages").textContent = String(pages);
  $("#total").textContent = String(total);
  $("#pageSize").value = String(pageSize);
}

function syncChkAll(){
  const rows = $$('#filesTbody .chkRow');
  const allOn = rows.length>0 && rows.every(x => x.checked);
  $("#chkAll").checked = allOn;
}

function updateActionButtons(){
  $("#btnExtractSelected").disabled = (selected.size === 0);
}

/* ========= 行為 ========= */
async function load(p=1){
  try{
    const data = await fetchPage(p, pageSize);
    page = data.page;
    total = data.total;
    pageSize = data.page_size;
    pages = Math.max(1, Math.ceil(total / pageSize));
    items = Array.isArray(data.items) ? data.items : [];
    renderTable();
    updatePager();
  }catch(e){
    alert('載入清單失敗：' + (e?.message || e));
  }
}

$("#prev").onclick = () => { if (page > 1) { load(page - 1); } };
$("#next").onclick = () => { if (page < pages) { load(page + 1); } };
$("#pageSize").onchange = () => { pageSize = parseInt($("#pageSize").value || '50', 10) || 50; load(1); };

$("#chkAll").addEventListener('change', (e) => {
  const on = e.target.checked;
  $$('#filesTbody .chkRow').forEach(ch => {
    ch.checked = on;
    const h = ch.value;
    if (on) selected.add(h); else selected.delete(h);
  });
  updateActionButtons();
});

/* ====== Modal: 開關 ====== */
const uploadModal = $('#uploadModal');
const urlModal = $('#urlModal');

$('#openUploadModal').onclick = () => uploadModal.classList.remove('hidden');
$('#openUrlModal').onclick = () => urlModal.classList.remove('hidden');

Array.from(document.querySelectorAll('.modal .close')).forEach(btn => {
  btn.onclick = (e) => {
    const modal = e.target.closest('.modal');
    modal.classList.add('hidden');
    if (modal.id === 'uploadModal') {
      fileMap.clear(); renderFileList();
      $('#uploadMultiMsg').textContent = '';
    }
    if (modal.id === 'urlModal') {
      modal.querySelector('textarea[name="urls"]').value = '';
      modal.querySelector('input[name="hsd_name"]').value = '';
      $('#urlBatchMsg').textContent = '';
    }
  };
});
[uploadModal, urlModal].forEach(m => {
  m.addEventListener('click', (e) => { if (e.target === m) m.classList.add('hidden'); });
});
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') { uploadModal.classList.add('hidden'); urlModal.classList.add('hidden'); }
});

/* ====== 上傳多檔：疊加/可移除/可清空，成功後刷新第 1 頁 ====== */
const uploadMultiForm = $('#uploadMultiForm');
const uploadInput = $('#uploadFiles');
const fileListEl = $('#fileList');
const clearAllBtn = $('#clearAllBtn');

const fileMap = new Map();
const fileKey = f => `${f.name}::${f.size}::${f.lastModified}`;

function renderFileList() {
  fileListEl.innerHTML = '';
  for (const [k, f] of fileMap) {
    const li = document.createElement('li');
    li.innerHTML = `
      <span>${escapeHtml(f.name)} <span class="meta">(${(f.size/1024).toFixed(1)} KB)</span></span>
      <button type="button" class="btn-link remove" data-k="${k}">移除</button>
    `;
    fileListEl.appendChild(li);
  }
  fileListEl.querySelectorAll('button.remove').forEach(btn => {
    btn.onclick = () => { fileMap.delete(btn.dataset.k); renderFileList(); };
  });
}

uploadInput.addEventListener('change', () => {
  Array.from(uploadInput.files || []).forEach(f => {
    const k = fileKey(f);
    if (!fileMap.has(k)) fileMap.set(k, f);
  });
  uploadInput.value = '';   // 允許重選同批檔案
  renderFileList();
});
clearAllBtn.onclick = () => { fileMap.clear(); renderFileList(); };

uploadMultiForm.onsubmit = async (e) => {
  e.preventDefault();
  if (!fileMap.size) { alert('尚未選擇檔案'); return; }
  const fd = new FormData();
  for (const f of fileMap.values()) fd.append('files', f, f.name);
  const res = await fetch(uploadMultiForm.action, { method: 'POST', body: fd });
  if (!res.ok){ alert('上傳失敗'); return; }
  const json = await res.json().catch(()=>({uploaded:0}));
  $('#uploadMultiMsg').textContent = `已上傳 ${json.uploaded||0} 檔案`;
  // 成功後刷新第 1 頁、關閉 modal、清空暫存
  await load(1);
  uploadModal.classList.add('hidden');
  fileMap.clear(); renderFileList();
};

/* ====== URL 批量：成功後刷新第 1 頁 ====== */
const urlBatchForm = $('#urlBatchForm');
urlBatchForm && (urlBatchForm.onsubmit = async (e) => {
  e.preventDefault();
  const fd = new FormData();
  const raw = urlBatchForm.querySelector('textarea[name="urls"]').value || '';
  const lines = raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
  if (!lines.length){ alert('請輸入至少一個 URL'); return; }
  for (const u of lines) fd.append('urls', u);
  const site = urlBatchForm.querySelector('input[name="hsd_name"]').value || '';
  if (site) fd.append('hsd_name', site);

  const res = await fetch(urlBatchForm.action, { method: 'POST', body: fd });
  if (!res.ok){ alert('建立下載任務失敗'); return; }
  const json = await res.json().catch(()=>({queued:0}));
  $('#urlBatchMsg').textContent = `已建立 ${json.queued||0} 個下載任務（前往「下載任務」頁面查看進度）`;

  // 成功後刷新第 1 頁並關閉 modal（下載完成後才會出現在清單，但先更新也無妨）
  await load(1);
  urlModal.classList.add('hidden');
  urlBatchForm.reset();
});

/* ====== 批量加入解析（序列化） ====== */
async function enqueueOne(hash, forceRerun) {
  const resp = await fetch("/api/tasks/queue", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ file_hashes: [hash], force_rerun: !!forceRerun }),
  });
  if (!resp.ok) {
    let msg = `HTTP ${resp.status}`;
    try { const j = await resp.json(); if (j.detail) msg = j.detail; } catch {}
    throw new Error(msg);
  }
  return resp.json();
}

$("#btnExtractSelected")?.addEventListener("click", async () => {
  const arr = Array.from(selected);
  if (arr.length === 0) { alert("請先選擇至少一個檔案"); return; }
  const forceRerun = $("#chkForceRerun")?.checked || false;

  const btn = $("#btnExtractSelected");
  const originalText = btn.textContent;
  btn.disabled = true;

  let ok = 0, fail = 0, errors = [];
  for (let i = 0; i < arr.length; i++) {
    const h = arr[i];
    btn.textContent = `加入解析中 ${i+1}/${arr.length}…`;
    try {
      await enqueueOne(h, forceRerun);
      ok++;
    } catch (e) {
      fail++; errors.push(`${h}: ${e?.message || e}`);
    }
  }
  btn.disabled = false;
  btn.textContent = originalText;

  if (fail === 0) alert(`成功加入解析：${ok} 筆`);
  else alert(`成功：${ok}，失敗：${fail}\n——\n${errors.slice(0,5).join("\n")}${errors.length>5?"\n...(more)":""}`);

  // 不重整頁面；若想即時看到 parsed 狀態變化，可定時輪詢另外的任務頁或定時 reload。
});

/* ====== Init ====== */
document.addEventListener('DOMContentLoaded', () => load(1));
</script>
{% endblock %}
