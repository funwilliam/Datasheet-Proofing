{% extends 'base.html' %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', path='css/spec_modal.css') }}">
<style>
  .page-header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .title-wrap{display:flex;flex-direction:column;gap:6px}
  .title-wrap h2{margin:0}
  .submeta{color:#6b7280;font-size:13px}
  .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:10px;font-size:14px;line-height:20px;text-decoration:none;cursor:pointer;border:1px solid transparent;background:#fff;color:#111827}
  .btn:focus{outline:2px solid rgba(59,130,246,.5);outline-offset:2px}
  .btn-primary{background:#111827;color:#fff;border-color:#111827}
  .btn-primary:hover{filter:brightness(.95)}
  .btn-outline{background:#fff;color:#111827;border:1px solid #e5e7eb}
  .btn-outline:hover{background:#f3f4f6}
  .btn-danger{background:#fff;color:#b91c1c;border:1px solid #fecaca}
  .btn-danger:hover{background:#fee2e2}
  .btn-sm{padding:6px 10px;font-size:13px;border-radius:8px}

  table.models{width:100%;border-collapse:collapse;table-layout:fixed;margin-top:16px}
  table.models th,table.models td{border-bottom:1px solid #e5e7eb;padding:10px 8px;vertical-align:middle;text-align:left}
  table.models th{background:#f9fafb;font-weight:600}
  .col-idx{width:64px}
  .col-model{width:auto}
  .col-status{width:110px}
  .col-files{width:220px}
  .col-ops{width:380px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;line-height:18px}
  .badge-verified{background:#DCFCE7;color:#065F46}
  .badge-unverified{background:#FEF3C7;color:#92400E}

  .files-list{margin:8px 0 0;padding:0;list-style:none;max-height:340px;overflow:auto;border:1px solid #e5e7eb;border-radius:8px}
  .files-list li{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #e5e7eb;gap:12px}
  .files-list li:last-child{border-bottom:none}
  .file-meta{color:#6b7280;font-size:12px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#f3f4f6;font-size:12px}
  .is-current{background:#DBEAFE;color:#1E3A8A}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
  <div class="title-wrap">
    <h2 id="fileTitle">檔案：</h2>
    <div class="submeta">
      hash: <code id="fileHashText" class="mono"></code>
      <span id="parsedBadge" class="badge" style="margin-left:8px"></span>
    </div>
  </div>
</div>

<div class="file-actions" style="margin-top:12px;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;display:flex;align-items:center;gap:12px;flex-wrap:wrap">
  <a id="openPdf" class="btn btn-outline" href="#" target="_blank" rel="noopener">開啟 PDF</a>
  <div class="sp" style="width:1px;height:22px;background:#e5e7eb"></div>
  <a id="reviewAllBtn" class="btn btn-outline" href="#">校對（整份）</a>
  <div class="sp" style="width:1px;height:22px;background:#e5e7eb"></div>
  <button type="button" id="queueBtn" class="btn btn-primary">加入解析佇列</button>
  <label class="help" title="若已存在解析結果，仍重新解析" style="color:#6b7280;font-size:12px">
    <input type="checkbox" id="forceRerun"> 強制重跑
  </label>
</div>

<h3 style="margin-top:18px;">已擷取的型號</h3>
<table class="models">
  <colgroup>
    <col class="col-idx">
    <col class="col-model">
    <col class="col-status">
    <col class="col-files">
    <col class="col-ops">
  </colgroup>
  <thead>
    <tr>
      <th>#</th>
      <th>型號</th>
      <th>狀態</th>
      <th>來源</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody id="modelsBody"></tbody>
</table>

{% include 'components/spec_modal.html' %}

<div id="filesModal" class="modal hidden">
  <div class="modal-body" style="max-width:720px">
    <h3>關聯檔案 — <span id="filesTitle" class="mono"></span></h3>
    <ul id="filesList" class="files-list"></ul>
    <div class="modal-actions">
      <button type="button" class="btn btn-outline" id="filesClose">關閉</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', path='js/spec_modal.js') }}"></script>
<script>
(function(){
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

  // 解析 URL 取得 file_hash
  const parts = location.pathname.split('/').filter(Boolean); // ["files", "{hash}"]
  const fileHash = parts[1];

  // 元件引用
  const fileTitle = $('#fileTitle');
  const fileHashText = $('#fileHashText');
  const parsedBadge = $('#parsedBadge');
  const openPdf = $('#openPdf');
  const reviewAllBtn = $('#reviewAllBtn');
  const queueBtn = $('#queueBtn');
  const forceRerun = $('#forceRerun');
  const tbody = $('#modelsBody');

  // 關聯檔案 modal
  const filesModal = $('#filesModal');
  const filesTitle = $('#filesTitle');
  const filesList  = $('#filesList');
  $('#filesClose').addEventListener('click', ()=>filesModal.classList.add('hidden'));
  filesModal.addEventListener('click', (e)=>{ if(e.target===filesModal) filesModal.classList.add('hidden'); });

  function badgeV(v){
    const isV = v === 'verified';
    return `<span class="badge ${isV?'badge-verified':'badge-unverified'}">${isV?'verified':'unverified'}</span>`;
  }

  async function loadFile(){
    const r = await fetch(`/api/files/${encodeURIComponent(fileHash)}`);
    if(!r.ok){ alert('讀取檔案失敗'); return; }
    const f = await r.json();

    fileTitle.textContent = `檔案：${f.filename || ''}`;
    fileHashText.textContent = f.file_hash;
    parsedBadge.textContent = f.parsed ? '已解析' : '未解析';
    parsedBadge.className = 'badge ' + (f.parsed ? 'badge-verified' : 'badge-unverified');

    openPdf.href = `/pdf/${encodeURIComponent(f.file_hash)}`;
    reviewAllBtn.href = `/review/${encodeURIComponent(f.file_hash)}`;
  }

  async function loadModels(){
    const r = await fetch(`/api/files/${encodeURIComponent(fileHash)}/models`);
    if(!r.ok){ alert('讀取型號失敗'); return; }
    const list = await r.json();

    tbody.innerHTML = '';
    list.forEach((m, i)=>{
      const tr = document.createElement('tr');
      tr.dataset.model = m.model_number;
      tr.innerHTML = `
        <td class="mono">${i+1}</td>
        <td class="mono">${m.model_number}</td>
        <td class="cell-status">${badgeV(m.verify_status)}</td>
        <td>
          <button type="button" class="btn btn-outline btn-sm btn-files" data-model="${m.model_number}">關聯檔案</button>
        </td>
        <td>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button type="button" class="btn btn-outline btn-sm btn-edit" data-model="${m.model_number}">規格參數</button>
            <button type="button" class="btn btn-outline btn-sm btn-unlink" data-model="${m.model_number}">解除關聯</button>
            <button type="button" class="btn btn-danger btn-sm btn-delete" data-model="${m.model_number}">刪除型號</button>
          </div>
        </td>`;
      tbody.appendChild(tr);
      bindRowActions(tr, m);
    });
  }

  // 共用規格參數 modal
  SpecModal.setup({
    fetchModel: async (modelNumber) => {
      const resp = await fetch(`/api/models/${encodeURIComponent(modelNumber)}`);
      if (!resp.ok) throw new Error(await resp.text());
      return await resp.json();
    },
    patchModel: async (modelNumber, payload) => {
      const resp = await fetch(`/api/models/${encodeURIComponent(modelNumber)}`, {
        method: 'PATCH',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (!resp.ok) throw new Error(await resp.text());
      return await resp.json();
    },
    onSaved: async () => {
      // 重新載入整張表，確保狀態、校對者、時間等都同步
      const y = window.scrollY;       // 可選：保留捲動位置，避免閃動
      await loadModels();
      window.scrollTo(0, y);
    }
  });

  async function unlinkModel(modelNumber){
    const resp = await fetch(`/api/files/${encodeURIComponent(fileHash)}/models/${encodeURIComponent(modelNumber)}`, { method: 'DELETE' });
    if (!resp.ok) throw new Error(await resp.text());
  }
  async function deleteModel(modelNumber){
    const resp = await fetch(`/api/models/${encodeURIComponent(modelNumber)}`, { method: 'DELETE' });
    if (!resp.ok) throw new Error(await resp.text());
  }

  function bindRowActions(tr, modelData){
    const model = tr.dataset.model;

    tr.querySelector('.btn-edit')?.addEventListener('click', ()=> SpecModal.openFor(model));

    tr.querySelector('.btn-files')?.addEventListener('click', async ()=>{
      try{
        const data = modelData || await SpecModal.api.fetchModel(model);
        filesTitle.textContent = model;
        filesList.innerHTML = '';
        const list = Array.isArray(data.files) ? data.files : [];
        if (!list.length){
          filesList.innerHTML = '<li><span class="file-meta">尚未建立關聯</span></li>';
        }else{
          for (const f of list){
            const isCurrent = f.file_hash === fileHash;
            const li = document.createElement('li');
            li.innerHTML = `
              <div>
                <a href="/files/${encodeURIComponent(f.file_hash)}" class="mono">${(f.file_hash||'').slice(0,8)}</a>
                <div class="file-meta">${(f.filename||'')}</div>
              </div>
              <span class="pill ${isCurrent?'is-current':''}">${isCurrent ? '這一份' : '其他檔案'}</span>
            `;
            filesList.appendChild(li);
          }
        }
        filesModal.classList.remove('hidden');
      }catch(e){
        alert('讀取關聯檔案失敗：' + (e?.message || e));
      }
    });

    tr.querySelector('.btn-unlink')?.addEventListener('click', async ()=>{
      if (!confirm(`確定要解除關聯？\n型號：${model}\n檔案：${fileHash.slice(0,8)}…`)) return;
      try{ await unlinkModel(model); tr.remove(); }catch(e){ alert('解除關聯失敗：' + (e?.message || e)); }
    });

    tr.querySelector('.btn-delete')?.addEventListener('click', async ()=>{
      if (!confirm(`⚠️ 這會刪除整個型號（包含與所有檔案的關聯）。\n確定刪除：${model} ？`)) return;
      try{ await deleteModel(model); tr.remove(); }catch(e){ alert('刪除失敗：' + (e?.message || e)); }
    });
  }

  // 解析入列
  queueBtn.addEventListener('click', async ()=>{
    const force = !!forceRerun.checked;
    const resp = await fetch('/api/tasks/queue', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ file_hashes: [fileHash], force_rerun: force })
    });
    if (!resp.ok) { const t = await resp.text().catch(()=> ''); alert('加入佇列失敗：' + t); return; }
    alert('已加入解析佇列');
  });

  // Init
  (async function init(){
    if(!fileHash){ alert('無效的檔案位址'); return; }
    await loadFile();
    await loadModels();
  })();
})();
</script>
{% endblock %}
