{% extends 'base.html' %}

{% block head_extra %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.min.js"
  integrity="sha512-Z8CqofpIcnJN80feS2uccz+pXWgZzeKxDsDNMD/dJ6997/LSRY+W4NmEt9acwR+Gt9OHN0kkI1CTianCwoqcjQ=="
  crossorigin="anonymous" referrerpolicy="no-referrer">
  </script>
{% endblock %}

{% block content %}
<style>
  #viewer {
    display: flex;
    gap: 16px;
  }

  #pdfPane {
    width: 50%;
    border: 1px solid #ddd;
    height: 85vh;
    overflow: auto;
  }

  #formPane {
    width: 50%;
  }

  pre.json {
    background: #111;
    color: #ddd;
    padding: 8px;
    border-radius: 6px;
    max-height: 60vh;
    overflow: auto;
  }
</style>

<h2>æ ¡å°ï¼š{{ m.model_number }}</h2>
<div id="viewer">
  <div id="pdfPane">
    <canvas id="pdfCanvas"></canvas>
    <div style="margin-top:8px;">
      <button onclick="prevPage()">ä¸Šä¸€é </button>
      <span>Page <span id="pageNum">1</span> / <span id="pageCount">?</span></span>
      <button onclick="nextPage()">ä¸‹ä¸€é </button>
      <input type="text" id="searchBox" placeholder="å…¨æ–‡æœå°‹..." />
      <button onclick="doSearch()">æœå°‹</button>
      <div id="searchRes"></div>
    </div>
  </div>
  <div id="formPane">
    <h3>æ¬„ä½ JSONï¼ˆéµç…§åŸæœ‰ schemaï¼‰</h3>
    <pre id="jsonView" class="json"></pre>

    <textarea id="jsonEdit" style="width:100%; height:240px; display:none;"></textarea>
    <p>
      <button id="editBtn" onclick="toggleEdit(true)">âœ ç·¨è¼¯</button>
      <button id="saveBtn" onclick="saveEdit()" style="display:none;">ğŸ’¾ å„²å­˜</button>
      <button id="cancelBtn" onclick="toggleEdit(false)" style="display:none;">å–æ¶ˆ</button>
    </p>

    <p>
      å¯©æ ¸ç‹€æ…‹ï¼š
      <select id="statusSel">
        <option value="pending" {% if m.verify_status=='pending' %}selected{% endif %}>pending</option>
        <option value="accepted" {% if m.verify_status=='accepted' %}selected{% endif %}>accepted</option>
        <option value="corrected" {% if m.verify_status=='corrected' %}selected{% endif %}>corrected</option>
        <option value="rejected" {% if m.verify_status=='rejected' %}selected{% endif %}>rejected</option>
      </select>
    </p>
    <p>
      å¯©æ ¸è€…ï¼š<input id="reviewer" value="" placeholder="å§“åæˆ–ä»£è™Ÿ" style="width:60%" />
    </p>
    <p>
      å‚™è¨»ï¼š<input id="notes" value="" placeholder="å‚™è¨»" style="width:100%" />
    </p>
    <p>
      <button onclick="saveStatus()">æ›´æ–°ç‹€æ…‹</button>
      <a href="/files/{{ fa.file_hash }}">â†© è¿”å›æª”æ¡ˆ</a>
    </p>
  </div>
</div>

<script>
  const fileHash = "{{ fa.file_hash }}";
  const modelId = "{{ m.id }}";
  let pdfDoc = null, pageNum = 1;

  async function loadModel() {
    const res = await fetch(`/api/models/${modelId}`);
    const m = await res.json();
    const pretty = JSON.stringify(m.fields_json, null, 2);
    document.getElementById('jsonView').textContent = pretty;
    document.getElementById('jsonEdit').value = pretty;
  }

  function toggleEdit(on) {
    document.getElementById('jsonView').style.display = on ? 'none' : 'block';
    document.getElementById('jsonEdit').style.display = on ? 'block' : 'none';
    document.getElementById('editBtn').style.display = on ? 'none' : 'inline-block';
    document.getElementById('saveBtn').style.display = on ? 'inline-block' : 'none';
    document.getElementById('cancelBtn').style.display = on ? 'inline-block' : 'none';
  }

  async function saveEdit() {
    try {
      const obj = JSON.parse(document.getElementById('jsonEdit').value);
      await fetch(`/api/models/${modelId}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ fields_json: obj, verify_status: 'corrected' }) });
      toggleEdit(false);
      loadModel();
      alert('å·²ä¿å­˜');
    } catch (e) { alert('JSON æ ¼å¼éŒ¯èª¤'); }
  }

  async function saveStatus() {
    const status = document.getElementById('statusSel').value;
    const reviewer = document.getElementById('reviewer').value;
    const notes = document.getElementById('notes').value;
    await fetch(`/api/models/${modelId}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ verify_status: status, reviewer, notes }) });
    alert('å·²æ›´æ–°');
  }

  // PDF.js
  document.addEventListener('DOMContentLoaded', async () => {
    await loadModel();
    const url = `/pdf/${fileHash}`;
    const loadingTask = window['pdfjsLib'].getDocument(url);
    pdfDoc = await loadingTask.promise;
    document.getElementById('pageCount').textContent = pdfDoc.numPages;
    renderPage(1);
  });

  async function renderPage(num) {
    pageNum = num;
    const page = await pdfDoc.getPage(num);

    const pdfPane = document.getElementById('pdfPane');
    const canvas = document.getElementById('pdfCanvas');
    const ctx = canvas.getContext('2d');

    // åŸå§‹ viewportï¼ˆscale = 1ï¼‰
    const unscaledViewport = page.getViewport({ scale: 1 });

    // è¨ˆç®—è¦ç¸®æ”¾çš„å€æ•¸ï¼ˆå®¹å™¨å¯¬åº¦ / PDF é è¨­å¯¬åº¦ï¼‰
    const scale = pdfPane.clientWidth / unscaledViewport.width;

    const viewport = page.getViewport({ scale });
    canvas.height = viewport.height;
    canvas.width = viewport.width;

    await page.render({ canvasContext: ctx, viewport }).promise;
    document.getElementById('pageNum').textContent = num;
  }
  function prevPage() { if (pageNum > 1) renderPage(pageNum - 1); }
  function nextPage() { if (pageNum < pdfDoc.numPages) renderPage(pageNum + 1); }

  async function doSearch() {
    const q = document.getElementById('searchBox').value;
    if (!q) return;
    const res = await fetch(`/api/files/${fileHash}/search?q=` + encodeURIComponent(q));
    const arr = await res.json();
    const s = arr.map(x => `ç¬¬ ${x.page} é ï¼šâ€¦${x.snippet}â€¦ <button onclick="renderPage(${x.page})">è·³é </button>`).join('<br/>');
    document.getElementById('searchRes').innerHTML = s || 'ç„¡çµæœ';
  }
</script>
{% endblock %}